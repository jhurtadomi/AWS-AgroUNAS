<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>AgroMarket - Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #2d6a4f;
      --primary-soft: #d8f3dc;
      --danger: #e63946;
      --bg: #f5f7fb;
      --text-main: #1b4332;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 1.5rem;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      gap: 0.8rem;
    }
    h1 {
      font-size: 1.4rem;
      color: var(--text-main);
      margin: 0;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #555;
      margin-top: 0.2rem;
    }
    .user-info {
      font-size: 0.9rem;
      color: #333;
      text-align: right;
    }
    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: var(--primary-soft);
      color: var(--primary);
      margin-left: 0.3rem;
    }
    button {
      padding: 0.4rem 0.7rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
    }
    #logout-btn {
      background: var(--danger);
      color: white;
    }
    #logout-btn:hover {
      background: #c71c30;
    }
    .layout {
      display: grid;
      grid-template-columns: 2fr 3fr;
      gap: 1rem;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 1rem 1.2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    .card h2 {
      font-size: 1.1rem;
      margin-top: 0;
      color: var(--primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
    }
    .tag {
      font-size: 0.7rem;
      background: #f1f3f5;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      color: #555;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.5rem 0.4rem;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      background: #f1f3f5;
      font-weight: 600;
    }
    .error {
      color: #b00020;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    .success {
      color: #2d6a4f;
      font-size: 0.85rem;
      margin-top: 0.4rem;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 0.6rem;
      margin-top: 0.6rem;
    }
    label {
      font-size: 0.8rem;
      color: #333;
      display: block;
      margin-bottom: 0.2rem;
    }
    input {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.85rem;
    }
    #add-product-btn {
      background: var(--primary);
      color: white;
      width: 100%;
      margin-top: 1.3rem;
    }
    #add-product-btn:disabled {
      background: #adb5bd;
      cursor: not-allowed;
    }
    .small-hint {
      font-size: 0.78rem;
      color: #666;
      margin-top: 0.3rem;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Panel AgroMarket</h1>
      <div class="subtitle">Consulta de precios e inventarios agrícolas</div>
    </div>
    <div class="user-info">
      Usuario: <span id="user-label"></span>
      <span class="badge" id="role-badge"></span><br/>
      <button id="logout-btn">Cerrar sesión</button>
    </div>
  </header>

  <div class="layout">
    <!-- CARD PRECIOS -->
    <div class="card">
      <h2>
        Precios del día
        <span class="tag">Solo lectura</span>
      </h2>
      <div id="prices-error" class="error"></div>
      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th>Precio</th>
            <th>Unidad</th>
          </tr>
        </thead>
        <tbody id="precios-body">
          <tr><td colspan="3">Cargando...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- CARD INVENTARIO -->
    <div class="card">
      <h2>
        Inventario
        <span class="tag" id="inventario-tag">Admin / Almacén</span>
      </h2>
      <div id="inventario-error" class="error"></div>
      <div id="inventario-success" class="success"></div>

      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th>Stock</th>
            <th>Unidad</th>
          </tr>
        </thead>
        <tbody id="inventario-body">
          <tr><td colspan="3">Cargando...</td></tr>
        </tbody>
      </table>

      <div id="inventario-form-wrapper">
        <hr style="margin: 0.9rem 0;" />
        <h3 style="font-size:0.95rem; margin:0 0 0.4rem 0; color:#333;">Agregar producto al inventario</h3>
        <div class="small-hint">
          Solo usuarios con rol <b>admin</b> o <b>almacen</b> pueden registrar stock.
        </div>
        <div class="form-grid">
          <div>
            <label for="prod-nombre">Producto</label>
            <input id="prod-nombre" type="text" placeholder="Café, Cacao, Plátano..." />
          </div>
          <div>
            <label for="prod-stock">Stock</label>
            <input id="prod-stock" type="number" min="0" placeholder="Ej: 120" />
          </div>
          <div>
            <label for="prod-unidad">Unidad</label>
            <input id="prod-unidad" type="text" placeholder="sacos, kg, cajas..." />
          </div>
        </div>
        <button id="add-product-btn">Guardar producto</button>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('agromarket_token');
    const user = localStorage.getItem('agromarket_user');
    const role = localStorage.getItem('agromarket_role');

    const userLabel = document.getElementById('user-label');
    const roleBadge = document.getElementById('role-badge');
    const logoutBtn = document.getElementById('logout-btn');

    const preciosBody = document.getElementById('precios-body');
    const pricesError = document.getElementById('prices-error');

    const inventarioBody = document.getElementById('inventario-body');
    const inventarioError = document.getElementById('inventario-error');
    const inventarioSuccess = document.getElementById('inventario-success');
    const inventarioFormWrapper = document.getElementById('inventario-form-wrapper');
    const addProductBtn = document.getElementById('add-product-btn');

    const prodNombre = document.getElementById('prod-nombre');
    const prodStock = document.getElementById('prod-stock');
    const prodUnidad = document.getElementById('prod-unidad');

    // Si no hay token -> fuera
    if (!token) {
      window.location.href = '/';
    }

    // Mostrar usuario y rol
    if (user) userLabel.textContent = user;
    if (role) {
      roleBadge.textContent = role;
    } else {
      roleBadge.textContent = 'sin rol';
    }

    // Si no es admin ni almacen, deshabilitar formulario de inventario
    const puedeEditarInventario = ['admin', 'almacen'].includes((role || '').toLowerCase());
    if (!puedeEditarInventario) {
      inventarioFormWrapper.style.opacity = '0.5';
      addProductBtn.disabled = true;
      inventarioError.textContent = 'Tu rol solo permite consultar; no puedes agregar productos.';
    }

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('agromarket_token');
      localStorage.removeItem('agromarket_user');
      localStorage.removeItem('agromarket_role');
      window.location.href = '/';
    });

    async function cargarPrecios() {
      try {
        const res = await fetch('/api/precios', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          pricesError.textContent = 'Error al obtener precios.';
          return;
        }

        const data = await res.json();
        const precios = data.data || [];
        preciosBody.innerHTML = '';

        if (precios.length === 0) {
          preciosBody.innerHTML = '<tr><td colspan="3">Sin datos de precios</td></tr>';
          return;
        }

        precios.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.producto}</td>
            <td>S/ ${item.precio}</td>
            <td>${item.unidad}</td>
          `;
          preciosBody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        pricesError.textContent = 'Error de conexión con el servidor.';
      }
    }

    async function cargarInventario() {
      try {
        const res = await fetch('/api/inventario', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!res.ok) {
          inventarioError.textContent = 'Error al obtener inventario.';
          return;
        }

        const data = await res.json();
        const items = data.data || [];
        inventarioBody.innerHTML = '';

        if (items.length === 0) {
          inventarioBody.innerHTML = '<tr><td colspan="3">Sin productos en inventario</td></tr>';
          return;
        }

        items.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.producto}</td>
            <td>${item.stock}</td>
            <td>${item.unidad}</td>
          `;
          inventarioBody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        inventarioError.textContent = 'Error de conexión con el servidor.';
      }
    }

    async function agregarProducto() {
      inventarioError.textContent = '';
      inventarioSuccess.textContent = '';

      const nombre = (prodNombre.value || '').trim();
      const stock = parseInt(prodStock.value || '0', 10);
      const unidad = (prodUnidad.value || '').trim();

      if (!nombre || !unidad || isNaN(stock)) {
        inventarioError.textContent = 'Completa nombre, stock y unidad.';
        return;
      }

      try {
        const res = await fetch('/api/inventario', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ producto: nombre, stock, unidad })
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          inventarioError.textContent = data.error || 'No se pudo agregar el producto.';
          return;
        }

        const data = await res.json();
        inventarioSuccess.textContent = data.message || 'Producto agregado correctamente.';
        prodNombre.value = '';
        prodStock.value = '';
        prodUnidad.value = '';

        // recargar tabla
        cargarInventario();
      } catch (err) {
        console.error(err);
        inventarioError.textContent = 'Error de conexión al guardar.';
      }
    }

    addProductBtn.addEventListener('click', () => {
      if (puedeEditarInventario) {
        agregarProducto();
      }
    });

    // Cargar datos al inicio
    cargarPrecios();
    cargarInventario();
  </script>
</body>
</html>
