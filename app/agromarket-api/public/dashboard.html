<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>AgroMarket - Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #2d6a4f;
      --primary-soft: #d8f3dc;
      --danger: #e63946;
      --bg: #f5f7fb;
      --text-main: #1b4332;
      --border-soft: #e5e7eb;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 1.5rem;
      color: #222;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      gap: 0.8rem;
    }

    h1 {
      font-size: 1.5rem;
      color: var(--text-main);
      margin: 0;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #555;
      margin-top: 0.2rem;
    }

    .user-info {
      font-size: 0.9rem;
      text-align: right;
    }

    .badge {
      display: inline-block;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: var(--primary-soft);
      color: var(--primary);
      margin-left: 0.3rem;
      text-transform: lowercase;
    }

    .badge.role-admin   { background: #ffe5ec; color: #d0004b; }
    .badge.role-almacen { background: #e0fbff; color: #0077b6; }

    button {
      padding: 0.42rem 0.8rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.15s ease, transform 0.05s ease;
    }

    button:active { transform: scale(0.98); }

    #logout-btn {
      background: var(--danger);
      color: white;
      margin-top: 0.3rem;
    }

    #logout-btn:hover { background: #c71c30; }

    .layout {
      display: grid;
      grid-template-columns: 2fr 3fr;
      gap: 1rem;
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 1rem 1.2rem 1.2rem;
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.15);
    }

    .card h2 {
      font-size: 1.1rem;
      margin-top: 0;
      color: var(--primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
    }

    .tag {
      font-size: 0.7rem;
      background: #f1f3f5;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      margin-top: 0.4rem;
    }

    th, td {
      padding: 0.5rem 0.45rem;
      border-bottom: 1px solid var(--border-soft);
      text-align: left;
      vertical-align: middle;
    }

    th {
      background: #f8fafc;
      font-weight: 600;
      color: #374151;
    }

    tr:last-child td { border-bottom: none; }

    .error {
      color: #b00020;
      font-size: 0.9rem;
      margin-top: 0.4rem;
    }

    .success {
      color: #2d6a4f;
      font-size: 0.85rem;
      margin-top: 0.35rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 0.6rem;
      margin-top: 0.6rem;
    }

    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
      #add-product-btn { margin-top: 0.6rem; }
    }

    label {
      font-size: 0.8rem;
      color: #374151;
      display: block;
      margin-bottom: 0.2rem;
    }

    input {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      font-size: 0.85rem;
    }

    input:focus {
      outline: 2px solid var(--primary-soft);
      outline-offset: 1px;
      border-color: var(--primary);
    }

    #add-product-btn {
      background: var(--primary);
      color: white;
      width: 100%;
      margin-top: 1.25rem;
    }

    #add-product-btn:disabled {
      background: #adb5bd;
      cursor: not-allowed;
    }

    .small-hint {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 0.3rem;
    }

    .actions-col { white-space: nowrap; }

    .btn-small {
      font-size: 0.78rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      margin-right: 0.2rem;
    }

    .btn-small.btn-edit {
      border-color: #2d6a4f33;
      color: #166534;
    }

    .btn-small.btn-delete {
      border-color: #fee2e2;
      color: #b91c1c;
    }

    .btn-small:hover { background: #e5e7eb; }

    .muted {
      color: #94a3b8;
      font-size: 0.8rem;
    }

    /* -------- MODALES BONITOS -------- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: #ffffff;
      border-radius: 14px;
      padding: 1rem 1.2rem 1rem;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.2);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .modal-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 0.4rem 0;
      color: #111827;
    }

    .modal-body {
      font-size: 0.85rem;
      color: #4b5563;
      margin-bottom: 0.6rem;
    }

    .modal-footer {
      margin-top: 0.8rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.4rem;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover { background: #d1d5db; }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover { background: #1b4332; }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover { background: #c71c30; }

    .modal label { margin-top: 0.3rem; }

    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Panel AgroMarket</h1>
      <div class="subtitle">Consulta de precios e inventarios agrícolas</div>
    </div>
    <div class="user-info">
      Usuario: <span id="user-label"></span>
      <span class="badge" id="role-badge"></span><br/>
      <button id="logout-btn">Cerrar sesión</button>
    </div>
  </header>

  <div class="layout">
    <!-- CARD PRECIOS -->
    <div class="card">
      <h2>
        Precios del día
        <span class="tag">Solo lectura</span>
      </h2>
      <div id="prices-error" class="error"></div>
      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th>Precio</th>
            <th>Unidad</th>
          </tr>
        </thead>
        <tbody id="precios-body">
          <tr><td colspan="3">Cargando precios...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- CARD INVENTARIO -->
    <div class="card">
      <h2>
        Inventario
        <span class="tag" id="inventario-tag">Admin / Almacén</span>
      </h2>

      <div id="inventario-error" class="error"></div>
      <div id="inventario-success" class="success"></div>

      <table>
        <thead>
          <tr>
            <th>Producto</th>
            <th>Stock</th>
            <th>Unidad</th>
            <th class="actions-header">Acciones</th>
          </tr>
        </thead>
        <tbody id="inventario-body">
          <tr><td colspan="4">Cargando inventario...</td></tr>
        </tbody>
      </table>

      <div id="inventario-form-wrapper">
        <hr style="margin: 0.9rem 0;" />
        <h3 style="font-size:0.95rem; margin:0 0 0.4rem 0; color:#111827;">Agregar producto al inventario</h3>
        <div class="small-hint">
          Solo usuarios con rol <b>admin</b> o <b>almacen</b> pueden registrar stock.
        </div>
        <div class="form-grid">
          <div>
            <label for="prod-nombre">Producto</label>
            <input id="prod-nombre" type="text" placeholder="Café, Cacao, Plátano..." />
          </div>
          <div>
            <label for="prod-stock">Stock</label>
            <input id="prod-stock" type="number" min="1" placeholder="Ej: 120" />
          </div>
          <div>
            <label for="prod-unidad">Unidad</label>
            <input id="prod-unidad" type="text" placeholder="sacos, kg, cajas..." />
          </div>
        </div>
        <button id="add-product-btn">Guardar producto</button>
      </div>
    </div>
  </div>

  <!-- MODAL EDITAR PRODUCTO -->
  <div id="modal-edit-overlay" class="modal-overlay hidden">
    <div class="modal">
      <h3 class="modal-title">Editar producto</h3>
      <div class="modal-body">
        <div style="margin-bottom:0.3rem;">
          Producto: <b id="modal-edit-product-name"></b>
        </div>
        <label for="modal-edit-stock">Nuevo stock (debe ser &gt; 0)</label>
        <input id="modal-edit-stock" type="number" min="1" />
        <label for="modal-edit-unit">Unidad</label>
        <input id="modal-edit-unit" type="text" />
        <div id="modal-edit-error" class="error"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="modal-edit-cancel">Cancelar</button>
        <button class="btn-primary" id="modal-edit-save">Guardar cambios</button>
      </div>
    </div>
  </div>

  <!-- MODAL ELIMINAR PRODUCTO -->
  <div id="modal-delete-overlay" class="modal-overlay hidden">
    <div class="modal">
      <h3 class="modal-title">Eliminar producto</h3>
      <div class="modal-body">
        ¿Seguro que deseas eliminar <b id="modal-delete-product-name"></b> del inventario?
        <div class="small-hint">Esta acción no se puede deshacer.</div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" id="modal-delete-cancel">Cancelar</button>
        <button class="btn-danger" id="modal-delete-confirm">Eliminar</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Datos básicos de sesión ----------
    const token = localStorage.getItem('agromarket_token');
    const user  = localStorage.getItem('agromarket_user');
    const role  = (localStorage.getItem('agromarket_role') || '').toLowerCase();

    const userLabel  = document.getElementById('user-label');
    const roleBadge  = document.getElementById('role-badge');
    const logoutBtn  = document.getElementById('logout-btn');

    const preciosBody      = document.getElementById('precios-body');
    const pricesError      = document.getElementById('prices-error');

    const inventarioBody   = document.getElementById('inventario-body');
    const inventarioError  = document.getElementById('inventario-error');
    const inventarioSuccess= document.getElementById('inventario-success');
    const inventarioFormWrapper = document.getElementById('inventario-form-wrapper');
    const addProductBtn    = document.getElementById('add-product-btn');

    const prodNombre = document.getElementById('prod-nombre');
    const prodStock  = document.getElementById('prod-stock');
    const prodUnidad = document.getElementById('prod-unidad');

    const puedeEditarInventario = ['admin', 'almacen'].includes(role);

    // Elementos del modal de edición
    const editOverlay   = document.getElementById('modal-edit-overlay');
    const editProdName  = document.getElementById('modal-edit-product-name');
    const editStockInput= document.getElementById('modal-edit-stock');
    const editUnitInput = document.getElementById('modal-edit-unit');
    const editError     = document.getElementById('modal-edit-error');
    const editCancelBtn = document.getElementById('modal-edit-cancel');
    const editSaveBtn   = document.getElementById('modal-edit-save');

    // Elementos del modal de eliminación
    const deleteOverlay   = document.getElementById('modal-delete-overlay');
    const deleteProdName  = document.getElementById('modal-delete-product-name');
    const deleteCancelBtn = document.getElementById('modal-delete-cancel');
    const deleteConfirmBtn= document.getElementById('modal-delete-confirm');

    let editingProductEncoded = null;
    let deletingProductEncoded= null;

    // Si no hay token, fuera al login
    if (!token) {
      window.location.href = '/';
    }

    // Mostrar usuario y rol
    userLabel.textContent = user || '(desconocido)';
    if (role) {
      roleBadge.textContent = role;
      roleBadge.classList.add(
        role === 'admin'   ? 'role-admin'   :
        role === 'almacen' ? 'role-almacen' : ''
      );
    } else {
      roleBadge.textContent = 'sin rol';
    }

    // Deshabilitar acciones de inventario si solo consulta
    if (!puedeEditarInventario) {
      inventarioFormWrapper.style.opacity = '0.5';
      addProductBtn.disabled = true;
      inventarioError.textContent = 'Tu rol solo permite consultar; no puedes agregar ni modificar inventario.';
      document.querySelectorAll('.actions-header').forEach(th => th.style.display = 'none');
    }

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('agromarket_token');
      localStorage.removeItem('agromarket_user');
      localStorage.removeItem('agromarket_role');
      window.location.href = '/';
    });

    // ---------- Utilidades para API ----------
    function getJSONData(resp) {
      return resp.data && Array.isArray(resp.data) ? resp.data :
             Array.isArray(resp) ? resp : [];
    }

    function mapPrecio(item) {
      return {
        producto: item.producto ?? item.product ?? '',
        precio:   item.precio,
        unidad:   item.unidad ?? item.unit ?? ''
      };
    }

    function mapInventario(item) {
      return {
        producto: item.producto ?? item.product ?? '',
        stock:    item.stock,
        unidad:   item.unidad ?? item.unit ?? ''
      };
    }

    // ---------- Cargar precios ----------
    async function cargarPrecios() {
      pricesError.textContent = '';
      try {
        const res = await fetch('/api/precios', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!res.ok) {
          pricesError.textContent = 'Error al obtener precios.';
          return;
        }

        const raw = await res.json();
        const precios = getJSONData(raw).map(mapPrecio);

        preciosBody.innerHTML = '';

        if (precios.length === 0) {
          preciosBody.innerHTML = '<tr><td colspan="3">Sin datos de precios</td></tr>';
          return;
        }

        precios.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.producto}</td>
            <td>S/ ${item.precio}</td>
            <td>${item.unidad}</td>
          `;
          preciosBody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        pricesError.textContent = 'Error de conexión con el servidor.';
      }
    }

    // ---------- Cargar inventario ----------
    async function cargarInventario() {
      inventarioError.textContent = '';
      try {
        const res = await fetch('/api/inventario', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!res.ok) {
          inventarioError.textContent = 'Error al obtener inventario.';
          return;
        }

        const raw = await res.json();
        const items = getJSONData(raw).map(mapInventario);

        renderInventario(items);
      } catch (err) {
        console.error(err);
        inventarioError.textContent = 'Error de conexión con el servidor.';
      }
    }

    function renderInventario(items) {
      inventarioBody.innerHTML = '';

      if (!items.length) {
        inventarioBody.innerHTML = '<tr><td colspan="4">Sin productos en inventario</td></tr>';
        return;
      }

      items.forEach(item => {
        const tr = document.createElement('tr');
        const encodedName = encodeURIComponent(item.producto);

        tr.innerHTML = `
          <td>${item.producto}</td>
          <td>${item.stock}</td>
          <td>${item.unidad}</td>
          <td class="actions-col">
            ${
              puedeEditarInventario
                ? `
                  <button class="btn-small btn-edit"
                          data-product="${encodedName}"
                          data-stock="${item.stock}"
                          data-unit="${item.unidad}">
                    Editar
                  </button>
                  <button class="btn-small btn-delete"
                          data-product="${encodedName}">
                    Eliminar
                  </button>
                `
                : '<span class="muted">Solo lectura</span>'
            }
          </td>
        `;

        inventarioBody.appendChild(tr);
      });

      if (puedeEditarInventario) {
        attachInventoryActions();
      }
    }

    // ---------- Modales ----------
    function openEditModal(encoded, name, stock, unit) {
      editingProductEncoded = encoded;
      editProdName.textContent = name;
      editStockInput.value = stock;
      editUnitInput.value = unit;
      editError.textContent = '';
      editOverlay.classList.remove('hidden');
    }

    function closeEditModal() {
      editingProductEncoded = null;
      editOverlay.classList.add('hidden');
    }

    function openDeleteModal(encoded, name) {
      deletingProductEncoded = encoded;
      deleteProdName.textContent = name;
      deleteOverlay.classList.remove('hidden');
    }

    function closeDeleteModal() {
      deletingProductEncoded = null;
      deleteOverlay.classList.add('hidden');
    }

    editCancelBtn.addEventListener('click', closeEditModal);
    deleteCancelBtn.addEventListener('click', closeDeleteModal);

    // Cerrar modales clickeando fondo
    editOverlay.addEventListener('click', (e) => {
      if (e.target === editOverlay) closeEditModal();
    });
    deleteOverlay.addEventListener('click', (e) => {
      if (e.target === deleteOverlay) closeDeleteModal();
    });

    // ---------- Acciones editar / eliminar ----------
    function attachInventoryActions() {
      const tokenHeader = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };

      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => {
          const enc   = btn.dataset.product;
          const name  = decodeURIComponent(enc);
          const stock = btn.dataset.stock;
          const unit  = btn.dataset.unit;
          openEditModal(enc, name, stock, unit);
        });
      });

      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const enc  = btn.dataset.product;
          const name = decodeURIComponent(enc);
          openDeleteModal(enc, name);
        });
      });

      // Guardar cambios de edición
      editSaveBtn.onclick = async () => {
        if (!editingProductEncoded) return;

        const productEncoded = editingProductEncoded;
        const product = decodeURIComponent(productEncoded);
        const newStock = Number(editStockInput.value || '0');
        const newUnit  = (editUnitInput.value || '').trim();

        editError.textContent = '';
        inventarioError.textContent = '';
        inventarioSuccess.textContent = '';

        if (!Number.isFinite(newStock) || newStock <= 0) {
          editError.textContent = 'El stock debe ser un número mayor a 0.';
          return;
        }
        if (!newUnit) {
          editError.textContent = 'La unidad es obligatoria.';
          return;
        }

        try {
          const res = await fetch(`/api/inventario/${productEncoded}`, {
            method: 'PUT',
            headers: tokenHeader,
            body: JSON.stringify({ producto: product, stock: newStock, unidad: newUnit })
          });

          const data = await res.json();
          if (!res.ok) {
            editError.textContent = data.error || 'Error al actualizar producto.';
            return;
          }

          inventarioSuccess.textContent = data.message || 'Producto actualizado correctamente.';
          const items = getJSONData(data).map(mapInventario);
          renderInventario(items);
          closeEditModal();
        } catch (err) {
          console.error(err);
          editError.textContent = 'Error de conexión al actualizar.';
        }
      };

      // Confirmar eliminación
      deleteConfirmBtn.onclick = async () => {
        if (!deletingProductEncoded) return;

        const productEncoded = deletingProductEncoded;

        inventarioError.textContent = '';
        inventarioSuccess.textContent = '';

        try {
          const res = await fetch(`/api/inventario/${productEncoded}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });

          const data = await res.json();
          if (!res.ok) {
            inventarioError.textContent = data.error || 'Error al eliminar producto.';
            return;
          }

          inventarioSuccess.textContent = data.message || 'Producto eliminado correctamente.';
          const items = getJSONData(data).map(mapInventario);
          renderInventario(items);
          closeDeleteModal();
        } catch (err) {
          console.error(err);
          inventarioError.textContent = 'Error de conexión al eliminar.';
        }
      };
    }

    // ---------- Agregar producto ----------
    async function agregarProducto() {
      inventarioError.textContent = '';
      inventarioSuccess.textContent = '';

      const nombre = (prodNombre.value || '').trim();
      const stock  = Number(prodStock.value || '0');
      const unidad = (prodUnidad.value || '').trim();

      if (!nombre || !unidad || !Number.isFinite(stock)) {
        inventarioError.textContent = 'Completa nombre, stock y unidad.';
        return;
      }

      if (stock <= 0) {
        inventarioError.textContent = 'El stock debe ser un número mayor a 0.';
        return;
      }

      try {
        const res = await fetch('/api/inventario', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ producto: nombre, stock, unidad })
        });

        const data = await res.json();

        if (!res.ok) {
          inventarioError.textContent = data.error || 'No se pudo agregar el producto.';
          return;
        }

        inventarioSuccess.textContent = data.message || 'Producto agregado correctamente.';
        prodNombre.value = '';
        prodStock.value  = '';
        prodUnidad.value = '';

        const items = getJSONData(data).map(mapInventario);
        renderInventario(items);
      } catch (err) {
        console.error(err);
        inventarioError.textContent = 'Error de conexión al guardar.';
      }
    }

    addProductBtn.addEventListener('click', () => {
      if (puedeEditarInventario) {
        agregarProducto();
      }
    });

    // ---------- Carga inicial ----------
    cargarPrecios();
    cargarInventario();
  </script>
</body>
</html>
